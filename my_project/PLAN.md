可解释交通应急快速响应系统（GCN+LSTM）

## 概述
- 目标：交付最小可演示版本（数据→图→训练→预测→解释→路径）。
- 范围：网格路网（轻量拓扑）、合成/缓存数据、单层 GCN + 单层 LSTM、Dijkstra 路径、模板解释、简易前端。
- 目录：全部内容位于 `D:/PGT/my_project`。

## 交付边界
- 必做：端到端可运行；CLI/简易 Web；关键指标与日志。
- 可选：真实 API（高德、天气），若耗时则改用缓存；LLM 解释可先用模板替代。
- 性能：节点 ≤ 1000，响应 ≤ 10s；准确率（拥堵等级）≥ 75%（口径一致）。

## 文件结构
- `README.md`、`requirements.txt`、`config.yaml`、`PLAN.md`
- `src/prepare_data.py`、`src/build_grid_graph.py`（Day 1）
- `src/train_eval.py`、`src/inference.py`、`src/explain.py`、`src/routing.py`、`src/app_streamlit.py`（后续）
- `data/`、`outputs/`（包含模型、日志、报告、图表）


## 核心定位
- 聚焦“时空精准预测 + 透明化决策 + 应急高效调度”。
- 用 `GCN + LSTM` 替代单纯 LSTM，强化路网空间关联捕捉（拥堵传导）。
- 保留 LLM 可解释与应急路径规划核心功能

## 核心目标
- 输入：事故位置、实时交通流、天气等。
- 输出：30 分钟内拥堵扩散时空预测（路段+时序）+ 自然语言解释 + 救援车辆最优路径。
- 指标：系统响应 ≤ 10 秒；拥堵等级预测准确率 ≥ 75%；可在普通笔记本或免费云服务器运行。


### 阶段 1：数据准备与图结构构建（1 周）—— 基础数据 + 轻量化图建模
1) 数据获取（公开易获取，无需权限）
- 核心数据：
  - 交通流数据：滴滴盖亚开放数据集（选取某城区约 10km²，提取 5 分钟级速度/位置，聚合各路段流量）；或采用 METR-LA/PeMS-Bay 作为替代基线。
  - 辅助数据：高德/百度地图开放 API 获取 POI（路口、小区、医院）；中国天气网 API 获取历史/实时天气（晴/雨/雪、能见度）。
  - 应急场景数据：手动模拟事故（指定路段“车道缩减比例”“事故发生时间”，如早高峰 7:30 在 XX 路口占道 1 条）。
- 数据筛选：保留连续 7 天数据（含工作日+周末），总量控制 ≤ 1GB，避免算力压力。

2) 数据处理与图结构搭建
- 数据预处理：
  - 特征提取：用 pandas 处理，得到 3 类核心特征——交通（5 分钟平均流量、速度）、环境（天气等级 1–5）、事件（事故影响权重：占道 1 条=0.3，2 条=0.6）。
  - 数据拆分：将交通流、天气、POI 拆分为 3 个“模拟跨部门数据源”，用差分隐私（拉普拉斯噪声，ε=1.0）处理，模拟数据孤岛与隐私保护。
- 轻量化图建模（核心适配 GCN）：
  - 节点定义：将目标区域划分为 50×50 网格（每格 200m×200m），每个网格作为 1 个节点，共 2500 节点（可缩减至 500–1000 以降算力）。
  - 邻接矩阵构建：采用“距离阈值法”——仅保留上下左右 4 邻接（元素=1），非相邻=0；最终邻接矩阵约 1000×1000（二进制矩阵，内存友好）。
  - 特征映射：形成“节点特征矩阵”（形状：时间步×节点数×特征数，如 12×1000×3）。
- 工具：Python（pandas、numpy）、地图 API、NetworkX（邻接可视化）。

### 阶段 2：核心模型搭建（2–3 周）—— GCN+LSTM 预测 + LLM 可解释 + 应急调度
A. GCN+LSTM 时空预测模型（约 1.5 周）—— 轻量化改造，易训练
- 模型架构（1 层 GCN + 1 层 LSTM；PyTorch 实现）：
  - 输入层：形状 `(batch, time_steps=12, nodes=1000, features=3)`。
  - GCN 层：输入维度=3，输出维度=32，激活=ReLU；捕捉空间关联（事故节点对相邻的拥堵传导）。
  - LSTM 层：隐藏维度=64，`batch_first=True`；捕捉时序依赖（拥堵蔓延趋势）。
  - 输出层：全连接，输出维度=1；预测未来 6×5 分钟的拥堵等级（1–5 级）。
- 训练优化（适配低算力）：
  - 超参数：`batch_size=8`、`epochs=15`、`lr=1e-3`（Adam）。
  - 算力适配：GPU（如 Colab T4）训练约 1–2 小时；无 GPU（仅 CPU）建议用 ChebNet 替代 GCN 或缩减节点至 500，训练约 3–4 小时。
  - 模型验证：70% 训练 / 30% 测试；关注事故场景准确率（≥75%）。
- 稳健性与加速：
  - 梯度裁剪（`clip_norm=1.0`）防止梯度爆炸；学习率调度（`StepLR/Cosine`）提升收敛。

B. LLM 可解释模块（约 0.5 周）—— 量化部署，快速对接
- 轻量化 LLM 选型：4 位量化的 ChatGLM-6B 或 Llama 2-7B（`llama.cpp` / `AutoAWQ`），模型体积可压至 ≤3GB，本地推理 ≤ 3 秒；资源受限可回退为模板解释。
- 对接逻辑（可用 LangChain 管道）：
  - 输入：“节点/路段未来 30 分钟拥堵等级变化 + 特征（事故权重/天气等级/时段/POI 密度）”。
  - 输出：固定模板生成解释，如“事故车道缩减 33%（权重 0.3）叠加小雨通行效率降低 15%，早高峰小区出行放大拥堵，预计扩散至 5 个节点、持续 28 分钟”。

C. 应急路径推演与调度（约 1 周）—— 算法简化，易实现
- 场景建模：在网格图上标注救援起点（医院）、事故点、障碍物（建筑网格不可通行）。
- 路径算法：
  - 优选：Dijkstra，以 GCN+LSTM 的“节点拥堵等级”作为权重；权重示例：拥堵 4–5 级权重=2，1–3 级权重=1，避开高权重路径。
  - 备选：简化蚁群算法（启发式=1/(预测拥堵+1)，初始信息素向救援方向偏置）。
- 调度输出：生成“起点→事故点”的最优路线（网格序列）、预计时长；用 `folium` 绘制路径地图与关键点弹窗。
- 工具：PyTorch（GCN+LSTM）、LangChain（LLM）、`llama.cpp`（量化）、NetworkX（路径）。

### 阶段 3：系统整合与测试优化（1 周）—— 可视化演示 + 问题修正
1) 模块整合（简易 Web 界面）
- 用 Streamlit 搭建界面，完成 3 个核心功能：
  - 数据输入区：下拉选择事故位置（网格编号）、天气等级、事故时间。
  - 结果展示区：显示“拥堵预测曲线 + 解释文本 + 救援路径地图”。
  - 应急建议区：自动生成“部署建议”（如“在拥堵蔓延的节点 C、D 增派交警”）。

2) 测试与优化
- 核心指标：
  - 预测准确率：测试集拥堵等级对比，确保 ≥ 75%。
  - 解释合理性：人工评估 10 个案例，解释包含“事故、天气、时段”三要素。
  - 响应速度：输入到输出 ≤ 10 秒（优化 LLM 推理、关闭冗余）。
- 问题修正：
  - 若准确率偏低：加入 POI 密度特征或将 GCN 输出维度调至 64。
  - 若响应偏慢：缩减节点（至 500），或以 XGBoost 替代 LSTM（训练+推理更快）。

### 阶段 4：成果整理与演示（1 周）—— 完善产出物，便于展示
- 核心产出物：
  - 可演示系统：Web 界面（附操作视频）。
  - 技术文档：1 页式架构图（GCN+LSTM+LLM+调度对接逻辑）、核心代码注释（GitHub 仓库）。
  - 效果报告：测试截图（预测曲线、路径地图、解释文本）、关键指标（准确率、响应速度）。

## 关键轻量化技巧（避坑核心）
- 图结构简化：节点数控制在 500–1000；邻接矩阵用二进制（0/1），避免加权复杂计算。
- 模型轻量化：GCN 与 LSTM 各 1 层；全连接维度 ≤ 128，防过拟合与降算力。
- LLM 优化：4 位量化 + 关闭非必要功能（如流式输出），本地推理速度提升约 2 倍；失败则回退模板解释。
- 代码复用：参考开源模板（GCN+LSTM 交通预测、LangChain + 地图 API 整合），减少重复开发。

## 项目亮点与延伸方向
- 亮点：时空融合预测、可解释透明化、应急调度直连实际场景；创新性与实用性兼顾。
- 延伸：后续可加入联邦学习（FedML 轻量版）、微调 LLM（应急场景小样本）、多救援车辆协同调度。

## 资源与工具清单
- 开发：`PyTorch`、`numpy<2`、`pandas`、`pyyaml`、`streamlit`、`folium`、`networkx`（可选 `transformers`、`langchain`）。
- 数据：滴滴盖亚开放数据集、METR-LA/PeMS-Bay、地图与天气开放 API（链接可在交付阶段统一整理）。
- 运行：Windows/Ubuntu 笔记本或免费云服务器；推荐 `Python 3.10`，显存/内存友好参数。

## 风险与应对
- 数据权限/可用性：优先使用开放数据与 API；无法获取时用合成数据回退（现有 `my_project/data` 已支持）。
- 算力不足：节点/时间步缩减、ChebNet 替代、量化 LLM 与模板回退。
- 版本不兼容：统一虚拟环境（`pgt`），锁定 `numpy<2`，避免大版本升级。
- 外部 API 不稳定：提供缓存与重试策略；断网下使用本地模拟数据。

## 交付与验收标准
- 可运行性：本地或云端可启动前端，页面加载正常，无阻断错误。
- 指标达成：响应 ≤ 10 秒，拥堵等级预测准确率 ≥ 75%。
- 结果完整：预测、解释、路径地图均可展示与导出；日志/模型/报告齐备。
- 文档完善：技术说明、运行手册、效果报告、操作视频与截图。

## 时间排期（示例）
- Week 1：数据与图结构完成，可视化邻接矩阵与样例特征。
- Week 2–3：模型训练与验证（含稳健性优化），输出曲线与指标。
- Week 4：LLM 解释与调度算法整合，完成前端交互与地图展示。
- Week 5–6（可选）：性能优化与真实数据接入，整理报告与演示视频。

## 实施状态总览（已完成 / 未完成 / 后续优化）

### 已完成
- 配置持久化与加载：`config.yaml` 支持路由与训练参数（`alpha`、`beta`、`gamma`、`avg_steps`、`epochs`、`clip_norm`、`lr_scheduler`、`step_size`、`gamma`）保存/回填；前端侧边栏与配置同步（`src/app_streamlit.py`）。
- 训练与日志：线程化训练、进度条、`train_events.log` 实时流式日志、`train_log.json` 曲线展示（`src/train_eval.py` + 前端）。
- 预测与路径规划：生成 `predictions.csv`；Dijkstra 基于拥堵/天气/事件权重的路径规划；Folium 地图嵌入与节点弹窗；导出 `route.json`（`src/inference.py`、`src/routing.py`、前端）。
- 解释报告：LLM可选启用、模型与模板选择、响应长度控制；产物 `explanation.txt` 与 `explanation.json`（`src/explain.py`、前端）。
- 数据与图：合成数据与网格图构建脚本（`src/prepare_data.py`、`src/build_grid_graph.py`），默认 30×30 网格可复现。
- 交付文档与脚本：`PLAN.md` 计划书、`run_demo.ps1` 一键演示、`CHECKLIST.md` 验收清单、`docs/dataset_links_and_templates.md` 数据集链接与模板说明、`templates/config.template.yaml` 模板与 `templates/README.md` 使用说明。

### 未完成（建议纳入验收扩展）
- 一键演示参数化与批量验证：`run_demo.ps1` 支持 `-epochs`、`-scheduler` 等参数及自动验收报告生成。
- 自动化报告与素材导出：前端关键视图自动截图、训练曲线汇总、导出 PDF/Word（含甘特图）。
- 单元测试与CI：为 `my_project/src` 模块补充最小单元测试与CI工作流（当前仓库测试主要覆盖库侧）。
- 性能基准与对比：不同网格规模（如 20×20 / 30×30 / 50×50）训练与推理基准，目标时延与稳定性评估报告。
- 外部数据适配：将 METR-LA/PEMS 等数据集适配到本项目数据接口，形成统一数据加载层与配置切换示例。
- 离线LLM演示包：提供本地轻量化模型下载与推理脚本，保证无网环境解释功能可演示。

### 后续优化（迭代方向）
- 路由算法增强：引入 A*（拥堵启发式）、多源多目标、时变边权（考虑预测未来时段）。
- 训练稳健性：早停、梯度累计、混合精度（AMP），更细粒度的学习率策略（OneCycle 等）。
- 推理管线：滑动窗口缓存与批量推理，加速预测生成；异常数据自动兜底与重试策略。
- 可视化与交互：地图图层增强（热力图/等值面）、多路线对比、可视化参数联动。
- MLOps：模型与数据版本记录、产线化打包、可重现性文档与自动化验收脚本。
- 文档与交付：将 `PLAN.md` 与 `CHECKLIST.md` 自动汇总为周报/里程碑报告；打包 ZIP 一键分发。

- Week 5–6（可选）：性能优化与真实数据接入，整理报告与演示视频。

## 附录（可按需补充）
- 数据集下载链接汇总：滴滴盖亚、METR-LA、PeMS-Bay、地图与天气 API（交付时统一给出可用链接）。
- 代码模板清单：GCN+LSTM 训练、邻接矩阵构建、LLM 对接、Dijkstra/蚁群示例。
- 运行命令一览：依赖安装、数据生成、图构建、训练/预测/路由/解释、前端启动（已在现有 `PLAN.md` 与 `README.md` 覆盖）。